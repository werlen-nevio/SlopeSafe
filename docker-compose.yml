services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: slopesafe-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: slopesafe
      MYSQL_USER: slopesafe_user
      MYSQL_PASSWORD: slopesafe_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - slopesafe-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Laravel Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: slopesafe-backend
    environment:
      APP_NAME: SlopeSafe
      APP_ENV: local
      APP_DEBUG: "true"
      APP_KEY: base64:YOUR_APP_KEY_HERE
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: slopesafe
      DB_USERNAME: slopesafe_user
      DB_PASSWORD: slopesafe_password
      QUEUE_CONNECTION: database
      SLF_API_BASE_URL: https://aws.slf.ch/api
      FCM_SERVER_KEY: ""
      FCM_API_URL: https://fcm.googleapis.com/fcm/send
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/var/www/html
      - backend_vendor:/var/www/html/vendor
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - slopesafe-network
    command: >
      sh -c "
        composer install --no-interaction &&
        php artisan key:generate --force &&
        php artisan migrate --force &&
        php artisan db:seed --force &&
        php artisan serve --host=0.0.0.0 --port=8000
      "

  # Laravel Scheduler (runs scheduled tasks like SLF sync every 30 min)
  scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: slopesafe-scheduler
    environment:
      APP_NAME: SlopeSafe
      APP_ENV: local
      APP_DEBUG: "true"
      APP_KEY: base64:YOUR_APP_KEY_HERE
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: slopesafe
      DB_USERNAME: slopesafe_user
      DB_PASSWORD: slopesafe_password
      QUEUE_CONNECTION: database
      SLF_API_BASE_URL: https://aws.slf.ch/api
      FCM_SERVER_KEY: ""
      FCM_API_URL: https://fcm.googleapis.com/fcm/send
    volumes:
      - ./backend:/var/www/html
      - backend_vendor:/var/www/html/vendor
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - slopesafe-network
    command: php artisan schedule:work
    restart: unless-stopped

  # Vue.js Web Frontend
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: slopesafe-web
    environment:
      VITE_API_BASE_URL: https://api.slopesafe.ch/api/v1
      VITE_APP_NAME: SlopeSafe
      VITE_DEFAULT_LANGUAGE: de
    ports:
      - "3000:3000"
    volumes:
      - ./web:/app
      - web_node_modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - slopesafe-network

networks:
  slopesafe-network:
    driver: bridge

volumes:
  mysql_data:
  backend_vendor:
  web_node_modules:
